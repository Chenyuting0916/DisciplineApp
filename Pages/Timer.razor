@page "/timer"
@using DisciplineApp.Services
@using DisciplineApp.Models
@inject GamificationService GamificationService
@inject AuthenticationStateProvider _authStateProvider
@inject ToastService ToastService
@inject TaskService TaskService
@inject IJSRuntime JSRuntime
@inject TimerService TimerService
@inject Microsoft.Extensions.Localization.IStringLocalizer<App> Localizer
@implements IDisposable

<div class="container text-center mt-5">
    <div class="mb-4">
        <div class="btn-group" role="group">
            <input type="radio" class="btn-check" name="mode" id="mode-pomodoro" autocomplete="off" checked="@TimerService.IsPomodoroMode" @onchange="@(() => TimerService.SetMode(true))">
            <label class="btn btn-outline-primary" for="mode-pomodoro">@Localizer["Pomodoro"]</label>

            <input type="radio" class="btn-check" name="mode" id="mode-stopwatch" autocomplete="off" checked="@(!TimerService.IsPomodoroMode)" @onchange="@(() => TimerService.SetMode(false))">
            <label class="btn btn-outline-primary" for="mode-stopwatch">@Localizer["Stopwatch"]</label>
        </div>
    </div>

    <div class="mb-4" style="max-width: 400px; margin: 0 auto;">
        @if (todayTasks != null && todayTasks.Any())
        {
            <select class="form-select bg-dark text-white border-secondary mb-2" @bind="TimerService.FocusTask" disabled="@TimerService.IsRunning">
                <option value="">@Localizer["SelectTask"]</option>
                @foreach (var task in todayTasks.Where(t => !t.IsCompleted || t.IsRoutine))
                {
                    <option value="@task.Title">@task.Title</option>
                }
                <option value="custom">@Localizer["CustomTask"]</option>
            </select>
        }
        
        @if (TimerService.FocusTask == "custom" || todayTasks == null || !todayTasks.Any())
        {
            <input type="text" class="form-control bg-dark text-white border-secondary text-center" 
                   placeholder="@Localizer["FocusPlaceholder"]" 
                   @bind="customFocusTask" 
                   disabled="@TimerService.IsRunning" />
        }
    </div>

    <div class="timer-display mb-5" style="font-size: 6rem; font-weight: bold; font-family: monospace;">
        @TimeDisplay
    </div>

    <div class="controls d-flex flex-column align-items-center gap-3">
        @if (!TimerService.IsRunning && !TimerService.IsPaused)
        {
            <button class="btn btn-lg btn-success px-5 rounded-pill" @onclick="StartTimer">
                <i class="bi bi-play-fill"></i> @Localizer["Start"]
            </button>
        }
        else if (TimerService.IsRunning)
        {
            <div class="d-flex gap-2">
                <button class="btn btn-lg btn-warning px-4 rounded-pill" @onclick="PauseTimer">
                    <i class="bi bi-pause-fill"></i> @Localizer["Pause"]
                </button>
                <button class="btn btn-lg btn-danger px-4 rounded-pill" @onclick="StopTimer">
                    <i class="bi bi-stop-fill"></i> @Localizer["Finish"]
                </button>
            </div>
        }
        else if (TimerService.IsPaused)
        {
             <div class="d-flex gap-2">
                <button class="btn btn-lg btn-success px-4 rounded-pill" @onclick="StartTimer">
                    <i class="bi bi-play-fill"></i> @Localizer["Resume"]
                </button>
                <button class="btn btn-lg btn-danger px-4 rounded-pill" @onclick="StopTimer">
                    <i class="bi bi-stop-fill"></i> @Localizer["Finish"]
                </button>
            </div>
        }
    </div>
    
    <DisciplineApp.Shared.CoinReward IsVisible="@showCoinReward" Coins="@coinsEarned" Xp="@xpEarned" />
    
    <audio id="timerSound" src="sounds/alarm.mp3" preload="auto"></audio>
    <audio id="startSound" src="sounds/start.mp3" preload="auto"></audio>
</div>

@code {
    private string customFocusTask = "";
    private List<UserTask>? todayTasks;
    
    // Reward State
    private bool showCoinReward = false;
    private int coinsEarned = 0;
    private int xpEarned = 0;

    protected override async Task OnInitializedAsync()
    {
        TimerService.OnTick += UpdateUI;
        TimerService.OnTimerCompleted += HandleTimerCompleted;
        
        // Restore state if timer is running or has a task set
        if (!string.IsNullOrEmpty(TimerService.FocusTask))
        {
            customFocusTask = TimerService.FocusTask;
        }
        
        await LoadTasks();
    }
    
    private async Task LoadTasks()
    {
        var authState = await _authStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated ?? false)
        {
            var userId = user.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value;
            if (!string.IsNullOrEmpty(userId))
            {
                todayTasks = await TaskService.GetTasksForDateAsync(userId, DateTime.Today);
            }
        }
    }

    private void UpdateUI()
    {
        InvokeAsync(StateHasChanged);
    }

    private string TimeDisplay => TimerService.IsPomodoroMode ? 
        $"{(int)TimerService.TimeLeft.TotalMinutes:D2}:{TimerService.TimeLeft.Seconds:D2}" : 
        $"{(int)TimerService.TimeElapsed.TotalMinutes:D2}:{TimerService.TimeElapsed.Seconds:D2}";

    private async Task StartTimer()
    {
        string taskName;
        
        // Determine the task name based on the current mode
        if (todayTasks == null || !todayTasks.Any() || TimerService.FocusTask == "custom")
        {
            taskName = customFocusTask;
        }
        else
        {
            taskName = TimerService.FocusTask;
        }

        // If no task name is provided, default to "Focus Session"
        if (string.IsNullOrWhiteSpace(taskName))
        {
            taskName = Localizer["Focus Session"] ?? "Focus Session";
        }
        
        // Update the service with the actual task name being used
        TimerService.FocusTask = taskName;
        
        TimerService.Start();
        await PlaySound("startSound");
    }

    private void PauseTimer()
    {
        TimerService.Stop();
    }

    private async Task StopTimer()
    {
        TimerService.Stop();
        
        // Calculate duration
        double durationMinutes = TimerService.IsPomodoroMode ? 
            (TimerService.DefaultPomodoroTime - TimerService.TimeLeft).TotalMinutes : 
            TimerService.TimeElapsed.TotalMinutes;

        // Only record if > 1 minute
        if (durationMinutes >= 0.1) 
        {
            await RecordSession(durationMinutes);
        }
        
        TimerService.ResetTimer();
    }

    private async void HandleTimerCompleted()
    {
        await InvokeAsync(async () => 
        {
            await PlaySound("timerSound");
            await RecordSession(TimerService.DefaultPomodoroTime.TotalMinutes);
            TimerService.ResetTimer();
            ToastService.ShowSuccess("Pomodoro Completed!");
        });
    }

    private async Task RecordSession(double minutes)
    {
        var authState = await _authStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated ?? false)
        {
            var userId = user.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value;
            if (!string.IsNullOrEmpty(userId))
            {
                string taskName = TimerService.FocusTask == "custom" ? customFocusTask : TimerService.FocusTask;
                if (string.IsNullOrEmpty(taskName)) taskName = customFocusTask;
                
                var result = await GamificationService.RecordFocusSessionAsync(userId, minutes, taskName, TimerService.IsPomodoroMode);
                
                if (result.success)
                {
                    xpEarned = result.xpAwarded;
                    coinsEarned = result.coinsAwarded;
                    
                    string msg = $"Session Recorded! +{xpEarned} XP";
                    
                    if (coinsEarned > 0)
                    {
                        showCoinReward = true;
                        StateHasChanged();
                        
                        // Hide animation after 3 seconds
                        var _ = Task.Delay(3000).ContinueWith(_ => 
                        {
                            showCoinReward = false;
                            InvokeAsync(StateHasChanged);
                        });
                        
                        msg += $" & +{coinsEarned} Coins!";
                    }
                    ToastService.ShowSuccess(msg);
                }
            }
        }
    }
    
    private async Task PlaySound(string elementId)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("playAudio", elementId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error playing sound: {ex.Message}");
        }
    }

    public void Dispose()
    {
        TimerService.OnTick -= UpdateUI;
        TimerService.OnTimerCompleted -= HandleTimerCompleted;
    }
}
