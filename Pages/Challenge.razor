@page "/challenge/{token}"
@using DisciplineApp.Services.Interfaces
@using ChallengeModel = DisciplineApp.Models.Challenge
@inject IChallengeService ChallengeService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IAnalyticsService AnalyticsService
@inject IJSRuntime JSRuntime
@inject TimerService TimerService
@inject Microsoft.Extensions.Localization.IStringLocalizer<App> Localizer

<PageTitle>@Localizer["Challenge"] - DisciplineApp</PageTitle>

<div class="container mt-5">
    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">@Localizer["Loading"]</span>
            </div>
        </div>
    }
    else if (challenge == null)
    {
        <div class="alert alert-danger text-center">
            <h4>@Localizer["ChallengeNotFound"]</h4>
            <p>@Localizer["ChallengeInvalidOrExpired"]</p>
            <a href="/" class="btn btn-primary">@Localizer["GoHome"]</a>
        </div>
    }
    else if (accepted)
    {
        <div class="text-center">
            <div class="display-1 mb-4">üéâ</div>
            <h1 class="display-4 mb-3">@Localizer["ChallengeAccepted"]</h1>
            <p class="lead mb-4">@Localizer["ChallengeTasksCreated"]</p>
            <a href="/tasks" class="btn btn-lg btn-primary">@Localizer["ViewTasks"]</a>
        </div>
    }
    else
    {
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card shadow-lg border-0">
                    <div class="card-body p-5 text-center">
                        <div class="mb-4">
                            <div class="display-1 mb-3">üèÜ</div>
                            <h1 class="display-5 fw-bold mb-3">@Localizer["YouveBeenChallenged"]</h1>
                        </div>

                        <div class="alert alert-info mb-4">
                            <h4 class="alert-heading">
                                <strong>@challenge.CreatedByName</strong> @Localizer["ChallengesYou"]
                            </h4>
                            <hr>
                            <p class="mb-0">
                                <strong>@GetChallengeDescription(challenge.Type)</strong>
                            </p>
                        </div>

                        <div class="mb-4">
                            <h5 class="text-muted mb-3">@Localizer["WhatYouGet"]</h5>
                            <ul class="list-unstyled">
                                <li class="mb-2">‚úÖ @Localizer["Challenge7Tasks"]</li>
                                <li class="mb-2">üéØ @Localizer["ChallengeBuildHabit"]</li>
                                <li class="mb-2">üèÖ @Localizer["ChallengeEarnXP"]</li>
                            </ul>
                        </div>

                        <button class="btn btn-lg btn-success px-5 py-3" @onclick="AcceptChallenge">
                            <span class="fs-4">@Localizer["AcceptChallenge"]</span>
                        </button>

                        @if (!isAuthenticated)
                        {
                            <p class="text-muted mt-3 small">
                                @Localizer["ChallengeGuestNote"]
                                <a href="/Identity/Account/Login">@Localizer["Login"]</a>
                            </p>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .card {
        border-radius: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .card-body {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        color: #333;
    }

    .alert-info {
        background-color: #e3f2fd;
        border-color: #2196f3;
        color: #0d47a1;
    }
</style>

@code {
    [Parameter] public string Token { get; set; } = "";
    
    private ChallengeModel? challenge;
    private bool isLoading = true;
    private bool accepted = false;
    private bool isAuthenticated = false;
    private string? userId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        isAuthenticated = user.Identity?.IsAuthenticated ?? false;
        
        if (isAuthenticated)
        {
            userId = user.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value;
        }

        challenge = await ChallengeService.GetChallengeByTokenAsync(Token);
        isLoading = false;

        // Track analytics
        await AnalyticsService.TrackEventAsync("Challenge_Viewed", "Challenge", Token);
    }

    private async Task AcceptChallenge()
    {
        if (challenge == null) return;

        var success = await ChallengeService.AcceptChallengeAsync(Token, userId);
        
        if (success)
        {
            accepted = true;
            
            // Track analytics
            var trackData = System.Text.Json.JsonSerializer.Serialize(new { 
                ChallengeType = challenge.Type,
                Challenger = challenge.CreatedByName,
                IsAuthenticated = isAuthenticated
            });
            await AnalyticsService.TrackEventAsync("Challenge_Accepted", "Challenge", trackData);
        }
    }

    private string GetChallengeDescription(string type)
    {
        return type switch
        {
            "7-day-focus" => Localizer["Challenge7DayDesc"],
            _ => Localizer["ChallengeUnknown"]
        };
    }
}
