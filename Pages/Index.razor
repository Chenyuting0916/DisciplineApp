@page "/"
@using DisciplineApp.Shared
@using DisciplineApp.Services
@using DisciplineApp.Models
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ITaskService TaskService
@inject ToastService ToastService
@inject IGamificationService GamificationService
@inject Microsoft.Extensions.Localization.IStringLocalizer<App> Localizer

<PageTitle>DisciplineApp - @Localizer["Home"]</PageTitle>

<HeadContent>
    <meta property="og:title" content="DisciplineApp - @Localizer["Home"]" />
    <meta property="og:description" content="A gamified productivity app to help you build discipline, track tasks, focus with Pomodoro timer, and compete on leaderboards." />
    <meta property="og:image" content="https://disciplineapp.azurewebsites.net/og-image.png" />
</HeadContent>

<AuthorizeView>
    <Authorized>
        <div class="dashboard-container pt-4">
            <div class="welcome-section mb-4 d-flex justify-content-between align-items-center">
                <div>
                    <h1>@Localizer["Welcome"], @(currentUser?.DisplayName ?? context.User.Identity?.Name ?? "User")!</h1>
                    <p class="text-muted">@Localizer["StayConsistent"]</p>
                </div>
                <div class="text-end">
                    <div class="d-flex align-items-center gap-3">
                        <div class="coin-display bg-dark p-2 rounded border border-warning text-warning fw-bold">
                            💰 @(currentUser?.GoldCoins ?? 0)
                        </div>
                        <div class="focus-display bg-dark p-2 rounded border border-info text-info fw-bold">
                            <div>⏱️ Total: @((int)(currentUser?.TotalFocusMinutes ?? 0))m</div>
                            <div class="small text-muted">Weekly: @((int)weeklyFocusMinutes)m</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-12">
                    <Heatmap />
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">@Localizer["TasksToday"]</h5>
                            <a href="tasks" class="btn btn-sm btn-outline-primary">@Localizer["ViewAll"]</a>
                        </div>
                        <div class="card-body">
                            @if (todayTasks == null)
                            {
                                <p class="text-muted">@Localizer["LoadingTasks"]</p>
                            }
                            else if (!todayTasks.Any())
                            {
                                <p class="text-muted">@Localizer["NoTasks"] <a href="tasks">@Localizer["AddOne"]</a>!</p>
                            }
                            else
                            {
                                var sortedTasks = todayTasks.OrderBy(t => !t.IsRoutine).ThenBy(t => t.Title).ToList();
                                <ul class="list-group list-group-flush">
                                    @foreach (var task in sortedTasks.Take(5))
                                    {
                                        <li class="list-group-item d-flex align-items-center @(task.IsCompleted ? "text-decoration-line-through text-muted" : "")" style="cursor: pointer;">
                                            <input type="checkbox" class="form-check-input me-2" checked="@task.IsCompleted" @onchange="() => ToggleTask(task)">
                                            @task.Title
                                            @if (task.IsRoutine)
                                            {
                                                <span class="badge bg-info text-dark ms-2">@Localizer["RoutineBadge"]</span>
                                            }
                                            @if (task.XpAwarded)
                                            {
                                                <span class="ms-auto badge bg-success">@Localizer["XPEarned"]</span>
                                            }
                                            else
                                            {
                                                <span class="ms-auto badge bg-secondary">+50 XP</span>
                                            }
                                        </li>
                                    }
                                </ul>
                                @if (todayTasks.Count > 5)
                                {
                                    <p class="text-muted mt-2 mb-0">+@(todayTasks.Count - 5) @Localizer["MoreTasks"]</p>
                                }
                            }
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                     <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">@Localizer["Weekly Focus"]</h5>
                            <div class="d-flex align-items-center gap-2">
                                <button class="btn btn-sm btn-outline-secondary" @onclick="PreviousWeek">
                                    <i class="bi bi-chevron-left"></i>
                                </button>
                                <span class="small text-muted">@weekRangeDisplay</span>
                                <button class="btn btn-sm btn-outline-secondary" @onclick="NextWeek" disabled="@isCurrentWeek">
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body d-flex flex-column">
                            @if (weeklyFocusBreakdown.Any())
                            {
                                <ul class="list-group list-group-flush mb-3 flex-grow-1">
                                    @foreach (var item in weeklyFocusBreakdown.OrderByDescending(x => x.Value))
                                    {
                                        <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent px-0">
                                            <span>@item.Key</span>
                                            <span class="badge bg-secondary rounded-pill">@((int)item.Value)m</span>
                                        </li>
                                    }
                                </ul>
                            }
                            else
                            {
                                <p class="text-muted text-center flex-grow-1 d-flex align-items-center justify-content-center">
                                    @Localizer["NoFocusSessions"]
                                </p>
                            }
                            
                            <div class="text-center mt-auto">
                                <a href="timer" class="btn btn-primary w-100">
                                    <i class="bi bi-play-circle-fill me-2"></i> @Localizer["StartFocusSession"]
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <DisciplineApp.Shared.CoinReward IsVisible="@showCoinReward" Coins="@coinsEarned" Xp="@xpEarned" />
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="text-center mt-5">
            <h1>@Localizer["Welcome"]</h1>
            <p class="lead">@Localizer["PleaseLoginTrack"]</p>
            <button class="btn btn-lg btn-primary" @onclick="ShowLoginModal">@Localizer["Login"]</button>
        </div>
    </NotAuthorized>
</AuthorizeView>

@if (showLoginModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-light border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">@Localizer["Login"]</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="HideLoginModal"></button>
                </div>
                <div class="modal-body text-center p-5">
                    <h4 class="mb-4">@Localizer["Welcome"]</h4>
                    <a href="Account/LoginWithGoogle" class="btn btn-lg btn-light w-100 d-flex align-items-center justify-content-center gap-2">
                        <img src="https://www.google.com/favicon.ico" alt="Google" width="20" height="20">
                        @Localizer["ContinueWithGoogle"]
                    </a>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .dashboard-container {
        max-width: 900px;
        margin: 0 auto;
    }
    .coin-display, .focus-display {
        min-width: 100px;
        text-align: center;
    }
</style>

@code {
    private List<UserTask>? todayTasks;
    private ApplicationUser? currentUser;
    private bool showLoginModal = false;
    private double weeklyFocusMinutes = 0;
    private Dictionary<string, double> weeklyFocusBreakdown = new();
    private DateTime currentWeekStart = DateTime.UtcNow.Date;
    
    private bool isCurrentWeek => currentWeekStart >= GetStartOfWeek(DateTime.UtcNow.Date);
    private string weekRangeDisplay => $"{currentWeekStart:MM/dd} - {currentWeekStart.AddDays(6):MM/dd}";

    // Reward State
    private bool showCoinReward = false;
    private int coinsEarned = 0;
    private int xpEarned = 0;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        // Initialize current week start
        currentWeekStart = GetStartOfWeek(DateTime.UtcNow.Date);

        if (user.Identity?.IsAuthenticated ?? false)
        {
            var userId = user.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value;
            if (!string.IsNullOrEmpty(userId))
            {
                todayTasks = await TaskService.GetTasksForDateAsync(userId, DateTime.Today);
                currentUser = await GamificationService.GetUserStatsAsync(userId);
                // Load for current week
                await LoadWeeklyStats(userId);
            }
        }
    }
    
    private DateTime GetStartOfWeek(DateTime date)
    {
        var diff = (7 + (date.DayOfWeek - DayOfWeek.Sunday)) % 7;
        return date.AddDays(-1 * diff).Date;
    }
    
    private async Task PreviousWeek()
    {
        currentWeekStart = currentWeekStart.AddDays(-7);
        await ReloadWeeklyStats();
    }
    
    private async Task NextWeek()
    {
        if (isCurrentWeek) return;
        currentWeekStart = currentWeekStart.AddDays(7);
        await ReloadWeeklyStats();
    }
    
    private async Task ReloadWeeklyStats()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userId = user.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value;
        if (!string.IsNullOrEmpty(userId))
        {
            await LoadWeeklyStats(userId);
        }
    }
    
    private async Task LoadWeeklyStats(string userId)
    {
        // Pass currentWeekStart as the reference date
        weeklyFocusMinutes = await GamificationService.GetWeeklyFocusTimeAsync(userId, currentWeekStart);
        weeklyFocusBreakdown = await GamificationService.GetWeeklyFocusBreakdownAsync(userId, currentWeekStart);
    }

    private async Task ToggleTask(UserTask task)
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated ?? false)
        {
            var userId = user.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value;
            if (!string.IsNullOrEmpty(userId))
            {
                var result = await TaskService.ToggleTaskCompletionAsync(task.Id, userId);
                
                if (result.success && result.xpAwarded > 0)
                {
                    xpEarned = result.xpAwarded;
                    
                    var coinResult = new Random().Next(0, 4); // 0-3 coins
                    if (coinResult > 0)
                    {
                        await GamificationService.AwardCoinsAsync(userId, coinResult, coinResult);
                        coinsEarned = coinResult;
                    }
                    else
                    {
                        coinsEarned = 0;
                    }

                    showCoinReward = true;
                    StateHasChanged();
                    
                    var _ = Task.Delay(3000).ContinueWith(_ => 
                    {
                        showCoinReward = false;
                        InvokeAsync(StateHasChanged);
                    });
                }
                else if (result.capReached)
                {
                    ToastService.ShowWarning(Localizer["DailyCapReached"]);
                }
                
                // Reload tasks
                todayTasks = await TaskService.GetTasksForDateAsync(userId, DateTime.Today);
                // Reload user stats to update header name/level/coins
                currentUser = await GamificationService.GetUserStatsAsync(userId);
                // Reload weekly stats just in case (though tasks don't affect focus time, XP does)
                // actually we don't strictly need to reload focus stats here if completing a task doesn't change focus time.
                // But let's leave as is or simplify.
                StateHasChanged();
            }
        }
    }

    private void ShowLoginModal() => showLoginModal = true;
    private void HideLoginModal() => showLoginModal = false;
}
