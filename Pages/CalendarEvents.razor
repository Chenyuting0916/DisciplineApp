@page "/calendar"
@using DisciplineApp.Services
@using Google.Apis.Calendar.v3
@using Google.Apis.Calendar.v3.Data
@inject DisciplineApp.Services.CalendarService CalendarService
@inject TaskService TaskService
@inject TokenProvider TokenProvider
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject Microsoft.Extensions.Localization.IStringLocalizer<App> Localizer

<PageTitle>@Localizer["Calendar"]</PageTitle>

<div class="calendar-container pt-4">
    <h3>@Localizer["Calendar"]</h3>

    @if (isLoading)
    {
        <p>Loading events...</p>
    }
    else if (calendarItems.Count == 0)
    {
        <p>No upcoming events or tasks found.</p>
    }
    else
    {
        <div class="list-group">
            @foreach (var item in calendarItems)
            {
                var borderClass = item.Type == CalendarItemType.Task ? "border-primary" : "border-warning";
                var badgeClass = item.Type == CalendarItemType.Task ? "bg-primary" : "bg-warning text-dark";
                var icon = item.Type == CalendarItemType.Task ? "‚úì" : "üìÖ";
                
                <div class="list-group-item list-group-item-action flex-column align-items-start border-start border-4 @borderClass">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1 text-truncate" style="max-width: 70%;">
                            <span class="badge @badgeClass me-2">@icon</span>
                            @item.Title
                        </h5>
                        <small class="text-nowrap ms-2">@item.Time.ToString("g")</small>
                    </div>
                    @if (!string.IsNullOrEmpty(item.Description))
                    {
                        <p class="mb-1 text-truncate" style="max-width: 100%;">@item.Description</p>
                    }
                    @if (!string.IsNullOrEmpty(item.Location))
                    {
                        <small class="text-muted d-block text-truncate">üìç @item.Location</small>
                    }
                    @if (item.Type == CalendarItemType.Task && item.IsCompleted)
                    {
                        <div class="mt-1">
                            <span class="badge bg-success">Completed</span>
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

<style>
    .calendar-container {
        max-width: 800px;
        margin: 0 auto;
    }
</style>

@code {
    private List<CalendarItem> calendarItems = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        Console.WriteLine($"Calendar Page - User authenticated: {user.Identity?.IsAuthenticated}");

        if (user.Identity?.IsAuthenticated ?? false)
        {
            var userId = user.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value;
            Console.WriteLine($"Calendar Page - User ID: {userId}");
            
            if (!string.IsNullOrEmpty(userId))
            {
                // 1. Fetch Google Calendar Events
                Events? googleEvents = null;
                
                Console.WriteLine($"Calendar Page - Access Token available: {!string.IsNullOrEmpty(TokenProvider.AccessToken)}");
                
                if (!string.IsNullOrEmpty(TokenProvider.AccessToken))
                {
                    try
                    {
                        Console.WriteLine("Calendar Page - Initializing CalendarService...");
                        await CalendarService.GetUpcomingEventsAsync(TokenProvider.AccessToken);
                        
                        if (CalendarService.Service != null)
                        {
                            Console.WriteLine("Calendar Page - Fetching events...");
                            var request = CalendarService.Service.Events.List("primary");
                            request.TimeMin = DateTime.Today;
                            request.TimeMax = DateTime.Today.AddDays(7);
                            request.SingleEvents = true;
                            request.OrderBy = EventsResource.ListRequest.OrderByEnum.StartTime;
                            
                            googleEvents = await request.ExecuteAsync();
                            Console.WriteLine($"Calendar Page - Events fetched: {googleEvents?.Items?.Count ?? 0}");
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Calendar Page - Error fetching Google Calendar events: {ex.Message}");
                    }
                }

                // 2. Fetch Local Tasks for next 7 days
                var tasks = new List<DisciplineApp.Models.UserTask>();
                for (int i = 0; i < 7; i++)
                {
                    var date = DateTime.Today.AddDays(i);
                    var dateTasks = await TaskService.GetTasksForDateAsync(userId, date);
                    if (dateTasks != null)
                    {
                        tasks.AddRange(dateTasks);
                    }
                }
                Console.WriteLine($"Calendar Page - Tasks fetched: {tasks.Count}");

                // 3. Merge Google Calendar events and local tasks
                if (googleEvents?.Items != null)
                {
                    foreach (var item in googleEvents.Items)
                    {
                        var start = item.Start.DateTime ?? DateTime.Parse(item.Start.Date);
                        calendarItems.Add(new CalendarItem
                        {
                            Title = item.Summary ?? "(No Title)",
                            Time = start,
                            Description = item.Description,
                            Location = item.Location,
                            Type = CalendarItemType.GoogleEvent
                        });
                    }
                }

                // Add tasks
                foreach (var task in tasks)
                {
                    calendarItems.Add(new CalendarItem
                    {
                        Title = task.Title,
                        Time = task.Date,
                        IsCompleted = task.IsCompleted,
                        Type = CalendarItemType.Task
                    });
                }

                // Sort by time
                calendarItems = calendarItems.OrderBy(i => i.Time).ToList();
                Console.WriteLine($"Calendar Page - Total calendar items: {calendarItems.Count}");
            }
        }
        isLoading = false;
    }

    public class CalendarItem
    {
        public string Title { get; set; } = "";
        public DateTime Time { get; set; }
        public string? Description { get; set; }
        public string? Location { get; set; }
        public bool IsCompleted { get; set; }
        public CalendarItemType Type { get; set; }
    }

    public enum CalendarItemType
    {
        GoogleEvent,
        Task
    }
}
