@page "/calendar"
@using Google.Apis.Calendar.v3.Data
@using DisciplineApp.Services
@inject CalendarService CalendarService
@inject TokenProvider TokenProvider
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Calendar</PageTitle>

<div class="calendar-container pt-4">
    <h2 class="mb-4">My Calendar & Tasks</h2>

    @if (!isAuthenticated)
    {
        <div class="alert alert-info">
            Please <a href="Account/LoginWithGoogle">log in with Google</a> to view your calendar and tasks.
        </div>
    }
    else if (isLoading)
    {
        <p>Loading your calendar and tasks...</p>
    }
    else
    {
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">ðŸ“… Upcoming Events</h5>
                    </div>
                    <div class="card-body">
                        @if (events == null || !events.Any())
                        {
                            <p class="text-muted">No upcoming events.</p>
                        }
                        else
                        {
                            <ul class="list-group list-group-flush">
                                @foreach (var evt in events.Take(10))
                                {
                                    <li class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <strong>@evt.Summary</strong>
                                                @if (evt.Start?.DateTimeDateTimeOffset != null)
                                                {
                                                    <br /><small class="text-muted">@evt.Start.DateTimeDateTimeOffset.Value.ToString("MMM dd, yyyy h:mm tt")</small>
                                                }
                                                else if (evt.Start?.Date != null)
                                                {
                                                    <br /><small class="text-muted">@evt.Start.Date (All day)</small>
                                                }
                                            </div>
                                        </div>
                                    </li>
                                }
                            </ul>
                        }
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">âœ… My Tasks</h5>
                    </div>
                    <div class="card-body">
                        @if (tasks == null || !tasks.Any())
                        {
                            <p class="text-muted">No tasks found.</p>
                        }
                        else
                        {
                            <ul class="list-group list-group-flush">
                                @foreach (var task in tasks.Take(10))
                                {
                                    <li class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <strong>@task.Title</strong>
                                                @if (!string.IsNullOrEmpty(task.Due))
                                                {
                                                    <br /><small class="text-muted">Due: @DateTime.Parse(task.Due).ToString("MMM dd, yyyy")</small>
                                                }
                                            </div>
                                        </div>
                                    </li>
                                }
                            </ul>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .calendar-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem;
    }
</style>

@code {
    private IList<Event>? events;
    private IList<Google.Apis.Tasks.v1.Data.Task>? tasks;
    private bool isLoading = true;
    private bool isAuthenticated = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        isAuthenticated = user.Identity?.IsAuthenticated ?? false;

        if (isAuthenticated)
        {
            try
            {
                // Fetch events for the next 30 days
                var startDate = DateTime.Today;
                var endDate = DateTime.Today.AddDays(30);
                events = await CalendarService.GetEventsAsync(startDate, endDate);

                // Fetch Google Tasks
                tasks = await CalendarService.GetTasksAsync();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading calendar data: {ex.Message}");
            }
        }

        isLoading = false;
    }
}
