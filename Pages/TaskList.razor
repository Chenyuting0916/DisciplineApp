@page "/tasks"
@using DisciplineApp.Services
@using DisciplineApp.Models
@using Microsoft.JSInterop
@inject ITaskService TaskService
@inject ICategoryService CategoryService
@inject IGamificationService GamificationService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject Microsoft.Extensions.Localization.IStringLocalizer<App> Localizer
@inject LocalStorageService LocalStorageService
@inject ToastService ToastService
@inject GuestTaskService GuestTaskService
@inject IAnalyticsService AnalyticsService
@inject IJSRuntime JSRuntime

@using DisciplineApp.Shared

<div class="task-container pt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>@Localizer["Tasks"]</h3>
        <div>
            @if (!string.IsNullOrEmpty(userId))
            {
                <button class="btn btn-outline-secondary me-2" @onclick="ShowManageCategoriesModal">
                    <span class="oi oi-tag"></span> @Localizer["ManageCategories"]
                </button>
            }
            <button class="btn btn-primary" @onclick="ShowAddTaskModal">
                <span class="oi oi-plus"></span> Add Task
            </button>
        </div>
    </div>

    <div class="task-list">
        @if (tasks == null)
        {
            <p>@Localizer["Loading"]</p>
        }
        else if (!tasks.Any())
        {
            <p class="text-muted">@Localizer["NoTasks"]</p>
        }
        else
        {
            var sortedTasks = tasks.OrderBy(t => !t.IsRoutine).ThenBy(t => t.Title).ToList();
            @foreach (var task in sortedTasks)
            {
                <div class="task-item card mb-2 p-3 @(task.IsCompleted ? "completed" : "")">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="form-check d-flex align-items-center">
                            <input class="form-check-input" type="checkbox" checked="@task.IsCompleted" @onchange="() => ToggleTask(task)" id="task-@task.Id">
                            <label class="form-check-label ms-2" for="task-@task.Id">
                                @task.Title
                            </label>
                            @if (task.IsRoutine)
                            {
                                <span class="badge bg-info text-dark ms-2">@Localizer["RoutineBadge"]</span>
                            }
                            @if (task.Category != null)
                            {
                                <span class="badge ms-2" style="background-color: @task.Category.ColorCode">@task.Category.Name</span>
                            }
                        </div>
                        <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteTask(task)">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                </div>
            }
        }
    </div>
</div>

<LevelUpOverlay @bind-IsVisible="showLevelUp" Level="newLevel" />

@if (showAddTaskModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-light border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">@Localizer["AddTask"]</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="HideAddTaskModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">@Localizer["TaskTitle"]</label>
                        <input type="text" class="form-control" @bind="newTaskTitle" placeholder="@Localizer["EnterTaskTitle"]" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">@Localizer["Category"]</label>
                        <select class="form-select" @bind="selectedCategoryId">
                            <option value="">@Localizer["Uncategorized"]</option>
                            @if (categories != null)
                            {
                                @foreach (var category in categories)
                                {
                                    <option value="@category.Id">@category.Name</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" @bind="isRoutineTask" id="modalRoutineCheck">
                        <label class="form-check-label" for="modalRoutineCheck">
                            @Localizer["RoutineLabel"]
                        </label>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" @onclick="HideAddTaskModal">@Localizer["Cancel"]</button>
                    <button type="button" class="btn btn-primary" @onclick="AddTaskFromModal">@Localizer["AddTask"]</button>
                </div>
            </div>
        </div>
    </div>
}

@if (showManageCategoriesModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-dark text-light border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">@Localizer["ManageCategories"]</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="HideManageCategoriesModal"></button>
                </div>
                <div class="modal-body">
                    @if (categories != null)
                    {
                        <div class="mb-3">
                            <button class="btn btn-sm btn-success" @onclick="ShowAddCategoryForm">
                                <span class="oi oi-plus"></span> @Localizer["AddCategory"]
                            </button>
                        </div>

                        @if (showAddCategoryForm)
                        {
                            <div class="card mb-3 p-3 bg-secondary">
                                <div class="mb-2">
                                    <label class="form-label">@Localizer["CategoryName"]</label>
                                    <input type="text" class="form-control" @bind="newCategoryName" placeholder="@Localizer["EnterCategoryName"]" />
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">@Localizer["CategoryColor"]</label>
                                    <input type="color" class="form-control form-control-color" @bind="newCategoryColor" />
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-primary me-2" @onclick="CreateCategory">@Localizer["Save"]</button>
                                    <button class="btn btn-sm btn-secondary" @onclick="HideAddCategoryForm">@Localizer["Cancel"]</button>
                                </div>
                            </div>
                        }

                        <div class="list-group">
                            @foreach (var category in categories)
                            {
                                <div class="list-group-item bg-dark border-secondary d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <span class="badge me-2" style="background-color: @category.ColorCode; width: 30px; height: 30px;"></span>
                                        @if (editingCategoryId == category.Id)
                                        {
                                            <input type="text" class="form-control form-control-sm me-2" style="width: 150px;" @bind="editCategoryName" />
                                            <input type="color" class="form-control form-control-color form-control-sm" @bind="editCategoryColor" />
                                        }
                                        else
                                        {
                                            <span>@category.Name</span>
                                            @if (category.UserId == null)
                                            {
                                                <span class="badge bg-info text-dark ms-2">@Localizer["SystemCategory"]</span>
                                            }
                                        }
                                    </div>
                                    <div>
                                        @if (editingCategoryId == category.Id)
                                        {
                                            <button class="btn btn-sm btn-success me-1" @onclick="SaveCategoryEdit">@Localizer["Save"]</button>
                                            <button class="btn btn-sm btn-secondary" @onclick="CancelCategoryEdit">@Localizer["Cancel"]</button>
                                        }
                                        else
                                        {
                                            @if (category.UserId != null)
                                            {
                                                <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => StartEditCategory(category)">@Localizer["EditCategory"]</button>
                                            }
                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteCategory(category)">@Localizer["DeleteCategory"]</button>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" @onclick="HideManageCategoriesModal">@Localizer["Cancel"]</button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .task-item.completed .form-check-label {
        text-decoration: line-through;
        color: var(--text-muted);
    }
    .task-container {
        max-width: 600px;
        margin: 0 auto;
    }
</style>

@code {
    private List<UserTask>? tasks;
    private List<Category>? categories;
    private string newTaskTitle = "";
    private int? selectedCategoryId;
    private bool isRoutineTask = false;
    private bool showAddTaskModal = false;
    private string userId = "";

    private bool showLevelUp = false;
    private int newLevel = 1;

    private void ShowAddTaskModal() => showAddTaskModal = true;
    private void HideAddTaskModal()
    {
        showAddTaskModal = false;
        newTaskTitle = "";
        selectedCategoryId = null;
        isRoutineTask = false;
    }

    private async Task AddTaskFromModal()
    {
        await AddTask();
        HideAddTaskModal();
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated ?? false)
        {
            userId = user.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value ?? "";
        }
        
        // Load categories (system defaults + user specific)
        categories = await CategoryService.GetCategoriesAsync(userId);

        if (!string.IsNullOrEmpty(userId))
        {
             tasks = await TaskService.GetTasksForDateAsync(userId, DateTime.Today);
        }
    }

    // Category management state
    private bool showManageCategoriesModal = false;
    private bool showAddCategoryForm = false;
    private string newCategoryName = "";
    private string newCategoryColor = "#808080";
    private int? editingCategoryId = null;
    private string editCategoryName = "";
    private string editCategoryColor = "";

    private void ShowManageCategoriesModal() => showManageCategoriesModal = true;
    private void HideManageCategoriesModal()
    {
        showManageCategoriesModal = false;
        showAddCategoryForm = false;
        editingCategoryId = null;
    }

    private void ShowAddCategoryForm() => showAddCategoryForm = true;
    private void HideAddCategoryForm()
    {
        showAddCategoryForm = false;
        newCategoryName = "";
        newCategoryColor = "#808080";
    }

    private async Task CreateCategory()
    {
        if (string.IsNullOrWhiteSpace(newCategoryName)) return;

        await CategoryService.CreateCategoryAsync(userId, newCategoryName, newCategoryColor);
        ToastService.ShowSuccess(Localizer["CategoryCreated"]);
        
        categories = await CategoryService.GetCategoriesAsync(userId);
        HideAddCategoryForm();
    }

    private void StartEditCategory(Category category)
    {
        editingCategoryId = category.Id;
        editCategoryName = category.Name;
        editCategoryColor = category.ColorCode;
    }

    private void CancelCategoryEdit()
    {
        editingCategoryId = null;
        editCategoryName = "";
        editCategoryColor = "";
    }

    private async Task SaveCategoryEdit()
    {
        if (editingCategoryId == null || string.IsNullOrWhiteSpace(editCategoryName)) return;

        var result = await CategoryService.UpdateCategoryAsync(editingCategoryId.Value, userId, editCategoryName, editCategoryColor);
        if (result != null)
        {
            ToastService.ShowSuccess(Localizer["CategoryUpdated"]);
            categories = await CategoryService.GetCategoriesAsync(userId);
        }
        
        CancelCategoryEdit();
    }

    private async Task DeleteCategory(Category category)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", Localizer["ConfirmDeleteCategory"].Value))
            return;

        var success = await CategoryService.DeleteCategoryAsync(category.Id, userId);
        if (success)
        {
            ToastService.ShowSuccess(Localizer["CategoryDeleted"]);
            categories = await CategoryService.GetCategoriesAsync(userId);
        }
        else
        {
            ToastService.ShowError(Localizer["CategoryInUse"]);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && string.IsNullOrEmpty(userId))
        {
            await LoadGuestTasks();
            StateHasChanged();
        }
    }

    private async Task LoadGuestTasks()
    {
        tasks = await GuestTaskService.GetTasksForTodayAsync(categories);
    }

    private async Task LoadTasks()
    {
        if (!string.IsNullOrEmpty(userId))
        {
            tasks = await TaskService.GetTasksForDateAsync(userId, DateTime.Today);
        }
        else
        {
            await LoadGuestTasks();
        }
    }

    private async Task AddTask()
    {
        if (string.IsNullOrWhiteSpace(newTaskTitle)) return;

        // Ensure we have userId for authenticated users
        if (tasks == null)
        {
            Console.WriteLine("Tasks not initialized yet, loading...");
            await LoadTasks();
        }

        if (!string.IsNullOrEmpty(userId))
        {
            try
            {
                await TaskService.AddTaskAsync(userId, newTaskTitle, DateTime.Today, isRoutineTask, selectedCategoryId);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error adding task: {ex.Message}");
                ToastService.ShowError(Localizer["FailedAddTask"]);
                return;
            }
        }
        else
        {
            await GuestTaskService.AddTaskAsync(newTaskTitle, isRoutineTask, selectedCategoryId, categories);
        }
        
        // Track analytics
        var trackData = System.Text.Json.JsonSerializer.Serialize(new { 
            Category = categories?.FirstOrDefault(c => c.Id == selectedCategoryId)?.Name ?? "Uncategorized",
            IsRoutine = isRoutineTask 
        });
        await AnalyticsService.TrackEventAsync("Task_Created", "Task", trackData);

        newTaskTitle = "";
        selectedCategoryId = null;
        isRoutineTask = false;
        await LoadTasks();
    }

    private async Task ToggleTask(UserTask task)
    {
        if (!string.IsNullOrEmpty(userId))
        {
            var result = await TaskService.ToggleTaskCompletionAsync(task.Id, userId);
            
                if (result.success && result.xpAwarded > 0)
            {
                string msg = string.Format(Localizer["XPEarnedRemaining"], result.xpAwarded, result.remainingDaily);
                ToastService.ShowSuccess(msg);
                
                if (result.levelUp)
                {
                    // Fetch updated user to get new level
                    var user = await GamificationService.GetUserStatsAsync(userId);
                    if (user != null)
                    {
                        newLevel = user.Level;
                        showLevelUp = true;
                    }
                }
            }
            else if (result.capReached)
            {
                ToastService.ShowWarning(Localizer["DailyCapReached"]);
            }
        }
        else
        {
            var wasCompleted = await GuestTaskService.ToggleTaskAsync(task.Id);
            if (wasCompleted)
            {
                ToastService.ShowInfo(Localizer["TaskCompletedGuest"]);
            }
        }
        await LoadTasks(); 
    }

    private async Task DeleteTask(UserTask task)
    {
        if (!string.IsNullOrEmpty(userId))
        {
            await TaskService.DeleteTaskAsync(task.Id, userId);
        }
        else
        {
            await GuestTaskService.DeleteTaskAsync(task.Id);
        }
        await LoadTasks();
    }
}
