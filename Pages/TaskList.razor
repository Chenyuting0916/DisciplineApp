@page "/tasks"
@using DisciplineApp.Services
@using DisciplineApp.Models
@inject ITaskService TaskService
@inject IGamificationService GamificationService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject Microsoft.Extensions.Localization.IStringLocalizer<App> Localizer
@inject LocalStorageService LocalStorageService
@inject ToastService ToastService

@using DisciplineApp.Shared

<div class="task-container pt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>@Localizer["Tasks"]</h3>
        <button class="btn btn-primary" @onclick="ShowAddTaskModal">
            <span class="oi oi-plus"></span> Add Task
        </button>
    </div>

    <div class="task-list">
        @if (tasks == null)
        {
            <p>@Localizer["Loading"]</p>
        }
        else if (!tasks.Any())
        {
            <p class="text-muted">@Localizer["NoTasks"]</p>
        }
        else
        {
            var sortedTasks = tasks.OrderBy(t => !t.IsRoutine).ThenBy(t => t.Title).ToList();
            @foreach (var task in sortedTasks)
            {
                <div class="task-item card mb-2 p-3 @(task.IsCompleted ? "completed" : "")">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="form-check d-flex align-items-center">
                            <input class="form-check-input" type="checkbox" checked="@task.IsCompleted" @onchange="() => ToggleTask(task)" id="task-@task.Id">
                            <label class="form-check-label ms-2" for="task-@task.Id">
                                @task.Title
                            </label>
                            @if (task.IsRoutine)
                            {
                                <span class="badge bg-info text-dark ms-2">@Localizer["RoutineBadge"]</span>
                            }
                            @if (task.Category != null)
                            {
                                <span class="badge ms-2" style="background-color: @task.Category.ColorCode">@task.Category.Name</span>
                            }
                        </div>
                        <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteTask(task)">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                </div>
            }
        }
    </div>
</div>

<LevelUpOverlay @bind-IsVisible="showLevelUp" Level="newLevel" />

@if (showAddTaskModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-light border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">@Localizer["AddTask"]</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="HideAddTaskModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">@Localizer["TaskTitle"]</label>
                        <input type="text" class="form-control" @bind="newTaskTitle" placeholder="@Localizer["EnterTaskTitle"]" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">@Localizer["Category"]</label>
                        <select class="form-select" @bind="selectedCategoryId">
                            <option value="">@Localizer["Uncategorized"]</option>
                            @if (categories != null)
                            {
                                @foreach (var category in categories)
                                {
                                    <option value="@category.Id">@category.Name</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" @bind="isRoutineTask" id="modalRoutineCheck">
                        <label class="form-check-label" for="modalRoutineCheck">
                            @Localizer["RoutineLabel"]
                        </label>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" @onclick="HideAddTaskModal">@Localizer["Cancel"]</button>
                    <button type="button" class="btn btn-primary" @onclick="AddTaskFromModal">@Localizer["AddTask"]</button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .task-item.completed .form-check-label {
        text-decoration: line-through;
        color: var(--text-muted);
    }
    .task-container {
        max-width: 600px;
        margin: 0 auto;
    }
</style>

@code {
    private List<UserTask>? tasks;
    private List<Category>? categories;
    private string newTaskTitle = "";
    private int? selectedCategoryId;
    private bool isRoutineTask = false;
    private bool showAddTaskModal = false;
    private string userId = "";
    private bool _hasRendered = false;

    private bool showLevelUp = false;
    private int newLevel = 1;

    private void ShowAddTaskModal() => showAddTaskModal = true;
    private void HideAddTaskModal()
    {
        showAddTaskModal = false;
        newTaskTitle = "";
        selectedCategoryId = null;
        isRoutineTask = false;
    }

    private async Task AddTaskFromModal()
    {
        await AddTask();
        HideAddTaskModal();
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated ?? false)
        {
            userId = user.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value ?? "";
        }
        
        // Load categories (system defaults + user specific)
        categories = await TaskService.GetCategoriesAsync(userId);

        if (!string.IsNullOrEmpty(userId))
        {
             tasks = await TaskService.GetTasksForDateAsync(userId, DateTime.Today);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && string.IsNullOrEmpty(userId))
        {
            _hasRendered = true;
            await LoadGuestTasks();
            StateHasChanged();
        }
    }

    private async Task LoadGuestTasks()
    {
        var allTasks = await LocalStorageService.GetItemAsync<List<UserTask>>("guest_tasks");

        if (allTasks == null || !allTasks.Any())
        {
            // First time guest! Initialize with default onboarding tasks
            allTasks = new List<UserTask>();
            
            // Helper to find category or fallback
            // We assume categories are loaded in OnInitializedAsync, but if we are here early or they failed, we hardcode defaults
            var workCat = categories?.FirstOrDefault(c => c.Id == 1) ?? new Category { Id = 1, Name = "Work", ColorCode = "#3B82F6" };
            var personalCat = categories?.FirstOrDefault(c => c.Id == 2) ?? new Category { Id = 2, Name = "Personal", ColorCode = "#10B981" };
            var learningCat = categories?.FirstOrDefault(c => c.Id == 4) ?? new Category { Id = 4, Name = "Learning", ColorCode = "#F59E0B" };

            // Task 1: Try adding a task (Learning)
            allTasks.Add(new UserTask
            {
                Id = 1,
                UserId = "guest",
                Title = Localizer["GuestTask1"],
                Date = DateTime.Today,
                IsRoutine = false,
                CategoryId = 4,
                Category = learningCat
            });

            // Task 2: Pomodoro (Work)
            allTasks.Add(new UserTask
            {
                Id = 2,
                UserId = "guest",
                Title = Localizer["GuestTask2"],
                Date = DateTime.Today,
                IsRoutine = false,
                CategoryId = 1,
                Category = workCat
            });

            // Task 3: Satisfaction (Personal)
            allTasks.Add(new UserTask
            {
                Id = 3,
                UserId = "guest",
                Title = Localizer["GuestTask3"],
                Date = DateTime.Today,
                IsRoutine = false,
                CategoryId = 2,
                Category = personalCat
            });

            await LocalStorageService.SetItemAsync("guest_tasks", allTasks);
        }
        
        // Filter for today's tasks OR routine tasks
        tasks = allTasks.Where(t => t.Date.Date == DateTime.Today || (t.IsRoutine && t.Date.Date <= DateTime.Today)).ToList();

        // Reset routine tasks if they were completed before today
        bool needsSave = false;
        foreach (var task in tasks.Where(t => t.IsRoutine && t.IsCompleted))
        {
            if (task.CompletedAt.HasValue && task.CompletedAt.Value.Date < DateTime.Today)
            {
                task.IsCompleted = false;
                task.CompletedAt = null;
                task.XpAwarded = false;
                needsSave = true;
            }
        }

        if (needsSave)
        {
            await LocalStorageService.SetItemAsync("guest_tasks", allTasks);
        }
    }

    private async Task LoadTasks()
    {
        if (!string.IsNullOrEmpty(userId))
        {
            tasks = await TaskService.GetTasksForDateAsync(userId, DateTime.Today);
        }
        else
        {
            await LoadGuestTasks();
        }
    }

    private async Task AddTask()
    {
        if (string.IsNullOrWhiteSpace(newTaskTitle)) return;

        // Ensure we have userId for authenticated users
        if (tasks == null)
        {
            Console.WriteLine("Tasks not initialized yet, loading...");
            await LoadTasks();
        }

        if (!string.IsNullOrEmpty(userId))
        {
            try
            {
                await TaskService.AddTaskAsync(userId, newTaskTitle, DateTime.Today, isRoutineTask, selectedCategoryId);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error adding task: {ex.Message}");
                ToastService.ShowError(Localizer["FailedAddTask"]);
                return;
            }
        }
        else
        {
            var allGuestTasks = await LocalStorageService.GetItemAsync<List<UserTask>>("guest_tasks") ?? new List<UserTask>();
            var newTask = new UserTask 
            { 
                Id = allGuestTasks.Any() ? allGuestTasks.Max(t => t.Id) + 1 : 1,
                UserId = "guest", 
                Title = newTaskTitle, 
                Date = DateTime.Today,
                IsRoutine = isRoutineTask,
                CategoryId = selectedCategoryId,
                Category = categories?.FirstOrDefault(c => c.Id == selectedCategoryId)
            };
            allGuestTasks.Add(newTask);
            await LocalStorageService.SetItemAsync("guest_tasks", allGuestTasks);
        }
        
        
        newTaskTitle = "";
        selectedCategoryId = null;
        isRoutineTask = false;
        await LoadTasks();
    }

    private async Task ToggleTask(UserTask task)
    {
        if (!string.IsNullOrEmpty(userId))
        {
            var result = await TaskService.ToggleTaskCompletionAsync(task.Id, userId);
            
                if (result.success && result.xpAwarded > 0)
            {
                string msg = string.Format(Localizer["XPEarnedRemaining"], result.xpAwarded, result.remainingDaily);
                ToastService.ShowSuccess(msg);
                
                if (result.levelUp)
                {
                    // Fetch updated user to get new level
                    var user = await GamificationService.GetUserStatsAsync(userId);
                    if (user != null)
                    {
                        newLevel = user.Level;
                        showLevelUp = true;
                    }
                }
            }
            else if (result.capReached)
            {
                ToastService.ShowWarning(Localizer["DailyCapReached"]);
            }
        }
        else
        {
            var allGuestTasks = await LocalStorageService.GetItemAsync<List<UserTask>>("guest_tasks") ?? new List<UserTask>();
            var target = allGuestTasks.FirstOrDefault(t => t.Id == task.Id);
            if (target != null)
            {
                target.IsCompleted = !target.IsCompleted;
                target.CompletedAt = target.IsCompleted ? DateTime.UtcNow : null;
                await LocalStorageService.SetItemAsync("guest_tasks", allGuestTasks);
                
                if (target.IsCompleted)
                {
                    ToastService.ShowInfo(Localizer["TaskCompletedGuest"]);
                }
            }
        }
        await LoadTasks(); 
    }

    private async Task DeleteTask(UserTask task)
    {
        if (!string.IsNullOrEmpty(userId))
        {
            await TaskService.DeleteTaskAsync(task.Id, userId);
        }
        else
        {
            var allGuestTasks = await LocalStorageService.GetItemAsync<List<UserTask>>("guest_tasks") ?? new List<UserTask>();
            var target = allGuestTasks.FirstOrDefault(t => t.Id == task.Id);
            if (target != null)
            {
                allGuestTasks.Remove(target);
                await LocalStorageService.SetItemAsync("guest_tasks", allGuestTasks);
            }
        }
        await LoadTasks();
    }
}
