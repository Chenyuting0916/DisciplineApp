@page "/leaderboard"
@using DisciplineApp.Services
@using DisciplineApp.Models
@inject IGamificationService GamificationService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject Microsoft.Extensions.Localization.IStringLocalizer<App> Localizer

<PageTitle>@Localizer["Leaderboard"]</PageTitle>

<div class="leaderboard-container pt-4">
    <h2 class="text-center mb-4">üèÜ @Localizer["Leaderboard"]</h2>

    <div class="d-flex justify-content-center mb-4">
        <div class="btn-group" role="group">
            <input type="radio" class="btn-check" name="sort" id="sort-xp" autocomplete="off" checked="@(sortBy == "xp")" @onchange="@(() => SortBy("xp"))">
            <label class="btn btn-outline-warning" for="sort-xp">@Localizer["LevelAndXP"]</label>

            <input type="radio" class="btn-check" name="sort" id="sort-coins" autocomplete="off" checked="@(sortBy == "coins")" @onchange="@(() => SortBy("coins"))">
            <label class="btn btn-outline-warning" for="sort-coins">@Localizer["GoldCoins"]</label>

            <input type="radio" class="btn-check" name="sort" id="sort-focus" autocomplete="off" checked="@(sortBy == "focus")" @onchange="@(() => SortBy("focus"))">
            <label class="btn btn-outline-warning" for="sort-focus">@Localizer["FocusTime"]</label>
        </div>
    </div>

    @if (users == null)
    {
        <p class="text-center">@Localizer["LoadingRankings"]</p>
    }
    else
    {
        <div class="card bg-dark border-secondary shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="text-center" style="width: 80px;">@Localizer["Rank"]</th>
                                <th>@Localizer["User"]</th>
                                <th class="text-center @(sortBy == "xp" ? "text-warning" : "")">@Localizer["Level"]</th>
                                <th class="text-end @(sortBy == "xp" ? "text-warning" : "")">@Localizer["TotalXP"]</th>
                                <th class="text-end @(sortBy == "coins" ? "text-warning" : "")">@Localizer["Coins"]</th>
                                <th class="text-end pe-4 @(sortBy == "focus" ? "text-warning" : "")">@Localizer["FocusTime"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < users.Count; i++)
                            {
                                var user = users[i];
                                var isCurrentUser = user.Id == currentUserId;
                                <tr class="@(isCurrentUser ? "table-active border-start border-4 border-primary" : "")">
                                    <td class="text-center align-middle">
                                        @if (i == 0)
                                        {
                                            <span class="fs-4">ü•á</span>
                                        }
                                        else if (i == 1)
                                        {
                                            <span class="fs-4">ü•à</span>
                                        }
                                        else if (i == 2)
                                        {
                                            <span class="fs-4">ü•â</span>
                                        }
                                        else
                                        {
                                            <span class="fw-bold text-muted">@(i + 1)</span>
                                        }
                                    </td>
                                    <td class="align-middle">
                                        <div class="d-flex align-items-center">
                                            @if (!string.IsNullOrEmpty(user.PhotoUrl))
                                            {
                                                <img src="@user.PhotoUrl" alt="@user.DisplayName" class="avatar-circle me-2" style="object-fit: cover;" />
                                            }
                                            else
                                            {
                                                <div class="avatar-circle me-2 bg-secondary text-white">
                                                    @(user.DisplayName?.FirstOrDefault() ?? user.UserName?.FirstOrDefault() ?? '?')
                                                </div>
                                            }
                                            <div>
                                                <div class="fw-bold @(isCurrentUser ? "text-primary" : "")">
                                                    @(user.DisplayName ?? user.UserName) 
                                                    @if (isCurrentUser)
                                                    {
                                                        <span class="small text-muted ms-1">(@Localizer["You"])</span>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center align-middle @(sortBy == "xp" ? "fw-bold" : "")">
                                        <span class="badge bg-info text-dark">Lvl @user.Level</span>
                                    </td>
                                    <td class="text-end align-middle @(sortBy == "xp" ? "fw-bold" : "")">
                                        @user.TotalXP.ToString("N0")
                                    </td>
                                    <td class="text-end align-middle text-warning @(sortBy == "coins" ? "fw-bold" : "")">
                                        üí∞ @user.GoldCoins
                                    </td>
                                    <td class="text-end align-middle pe-4 @(sortBy == "focus" ? "fw-bold" : "")">
                                        @((int)user.TotalFocusMinutes)m
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .leaderboard-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 1rem;
    }
    
    .avatar-circle {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
    }
    
    .table-active {
        --bs-table-accent-bg: rgba(13, 110, 253, 0.1);
    }
</style>

@code {
    private List<ApplicationUser>? users;
    private string currentUserId = "";
    private string sortBy = "xp";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated ?? false)
        {
            currentUserId = user.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value ?? "";
        }
        
        await LoadLeaderboard();
    }

    private async Task SortBy(string sort)
    {
        sortBy = sort;
        await LoadLeaderboard();
    }

    private async Task LoadLeaderboard()
    {
        users = await GamificationService.GetLeaderboardAsync(20, sortBy);
    }
}
